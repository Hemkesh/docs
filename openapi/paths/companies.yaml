# Companies API Endpoints

/companies:
  get:
    operationId: listCompanies
    summary: List companies
    description: |
      Retrieve a paginated list of companies in your deal flow pipeline.
      Supports filtering, sorting, and full-text search.

      **Note**: Pagination uses cursor-based `has_next`/`has_prev` for performance.
      Total counts are not provided to optimize response times.
    tags:
      - Companies
    parameters:
      - $ref: '#/components/parameters/PageParam'
      - $ref: '#/components/parameters/LimitParam'
      - $ref: '#/components/parameters/SortByParam'
      - $ref: '#/components/parameters/SortOrderParam'
      - $ref: '#/components/parameters/SearchParam'
      - name: visibility
        in: query
        required: false
        description: Filter by visibility level
        schema:
          type: string
          enum: [private, shared, team]
      - name: source
        in: query
        required: false
        description: Filter by source
        schema:
          type: string
          enum: [manual, email, form, referral, website, event, other]
      - name: company_status_id
        in: query
        required: false
        description: Filter by status ID. Use 'no_status' for companies without a status.
        schema:
          type: string
      - name: include_pdf_url
        in: query
        required: false
        description: Include signed download URLs for pitch deck PDFs
        schema:
          type: boolean
          default: false
    responses:
      '200':
        description: Successful response
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompanyListResponse'
            example:
              success: true
              data:
                companies:
                  - id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
                    account_id: "11111111-2222-3333-4444-555555555555"
                    name: "Acme Technologies"
                    deck_link: "https://docsend.com/view/example123"
                    visibility: "team"
                    source: "form"
                    company_status_id: null
                    notes: "Met at TechCrunch Disrupt 2024"
                    created_at: "2024-01-15T10:30:00.000000+00:00"
                    updated_at: "2024-01-15T12:45:00.000000+00:00"
                    created_by: "user-uuid-1234"
                    updated_by: "user-uuid-1234"
                    assignees: []
                    company_status: null
                    metadata:
                      founders:
                        - name: "Jane Smith"
                          email: "jane@example.com"
                          title: "CEO/Co-Founder"
                          linkedin_profile: "https://www.linkedin.com/in/example/"
                      ai_analysis: "B2B SaaS platform for enterprise workflow automation..."
                      analyzed_at: "2024-01-15T12:45:00.000Z"
                      user_preferences:
                        - type: "text"
                          field: "Website"
                          value: "https://example.com"
                          options: []
                          show_in_table: true
                pagination:
                  page: 1
                  limit: 25
                  has_next: true
                  has_prev: false
              authType: "api_key"
      '401':
        $ref: '#/components/responses/UnauthorizedError'
      '500':
        $ref: '#/components/responses/InternalServerError'

/companies/upload/ai:
  post:
    operationId: createCompanyWithAI
    summary: Create company with AI processing
    description: |
      **The recommended way to create companies in Roulette.**

      This intelligent endpoint accepts unstructured text (emails, notes, form data) and
      file attachments, then uses AI to automatically:

      1. **Extract URLs** from text using regex (handles long signed URLs from DocSend, Tally, etc.)
      2. **Prioritize deck sources** by known platforms (DocSend, Papermark, Brieflink, Google Drive)
      3. **Select the best pitch deck** from URLs or files
      4. **Auto-detect company status** based on content context
      5. **Auto-detect source** (email, referral, form, etc.) from content
      6. **Upload remaining files** as attachments

      ## How It Works

      ### URL Priority (Highest â†’ Lowest)
      1. DocSend links
      2. Papermark links
      3. Brieflink links
      4. Tally storage URLs
      5. Google Drive links
      6. Other URLs

      ### File Processing Logic
      - **Single file**: Always treated as the pitch deck (regardless of type)
      - **Multiple files**: AI analyzes PDF content to select the best deck candidate
      - **Fallback**: First PDF file if AI can't determine

      ### Context Analysis
      When text content is provided (>50 chars), the AI analyzes it to:
      - Detect appropriate pipeline status based on conversation context
      - Identify the source (email forward, referral mention, etc.)

      ## Use Cases

      - **Email forwarding**: Paste the full email body + attachments
      - **Form submissions**: Send form data as text + any uploaded files
      - **Manual entry**: Provide company info + deck URL or file
      - **Bulk import**: Process founder outreach emails automatically

    tags:
      - Companies
    requestBody:
      required: true
      content:
        multipart/form-data:
          schema:
            $ref: '#/components/schemas/AiUploadRequest'
          examples:
            emailForward:
              summary: Forward a founder email
              value:
                text: |
                  From: founder@startup.com
                  Subject: Intro - TechCo Series A

                  Hi, I'm the founder of TechCo. We're building AI tools for developers.
                  Here's our deck: https://docsend.com/view/abc123

                  We're currently raising a $5M Series A.
                account_id: "550e8400-e29b-41d4-a716-446655440000"
            withFiles:
              summary: Upload with pitch deck file
              value:
                text: "Meeting notes from coffee chat with Jane from StartupXYZ"
                account_id: "550e8400-e29b-41d4-a716-446655440000"
                name: "StartupXYZ"
                visibility: "team"
                file_0: "(binary)"
            simpleCreate:
              summary: Simple company with deck URL
              value:
                text: "https://pitch.com/public/startup-deck-abc123"
                account_id: "550e8400-e29b-41d4-a716-446655440000"
                name: "My Startup"
    responses:
      '200':
        description: Company created successfully with AI analysis
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AiUploadResponse'
            example:
              success: true
              data:
                company:
                  id: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
                  account_id: "550e8400-e29b-41d4-a716-446655440000"
                  name: "TechCo"
                  visibility: "team"
                  source: "email"
                  company_status_id: "initial-review-uuid"
                  notes: null
                  created_at: "2024-01-15T10:30:00Z"
                  updated_at: "2024-01-15T10:30:00Z"
                pdfDownloadUrl: "https://storage.useroulette.com/signed-url..."
                attachments:
                  - id: "attach-uuid-1"
                    title: "Financial Model.xlsx"
                    filePath: "companies/7c9e6679/attachments/financial-model.xlsx"
                    attachmentType: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                analysis:
                  detectedUrls:
                    - "https://docsend.com/view/abc123"
                  selectedDeckUrl: "https://docsend.com/view/abc123"
                  aiReasoning: "Selected DocSend URL as primary deck source (high priority platform)"
                  contextAnalysis:
                    statusDetected: true
                    statusReasoning: "Email mentions 'Series A raise' - assigned to fundraising stage"
                    sourceDetected: true
                    sourceReasoning: "Content appears to be a forwarded email from founder"
                  processedAt: "2024-01-15T10:30:00Z"
              authType: "api_key"
      '400':
        $ref: '#/components/responses/BadRequestError'
      '401':
        $ref: '#/components/responses/UnauthorizedError'
      '500':
        $ref: '#/components/responses/InternalServerError'

/companies/{id}:
  get:
    operationId: getCompany
    summary: Get company details
    description: Retrieve detailed information about a specific company.
    tags:
      - Companies
    parameters:
      - $ref: '#/components/parameters/CompanyIdParam'
      - name: include_pdf_url
        in: query
        required: false
        description: Include signed download URL for pitch deck PDF
        schema:
          type: boolean
          default: false
    responses:
      '200':
        description: Successful response
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompanyResponse'
      '401':
        $ref: '#/components/responses/UnauthorizedError'
      '404':
        $ref: '#/components/responses/NotFoundError'
      '500':
        $ref: '#/components/responses/InternalServerError'

  patch:
    operationId: updateCompany
    summary: Update a company
    description: |
      Update company information. Only include fields you want to change.
    tags:
      - Companies
    parameters:
      - $ref: '#/components/parameters/CompanyIdParam'
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CompanyUpdate'
          example:
            name: "Acme Corp (Updated)"
            company_status_id: "status-uuid-here"
            metadata:
              user_preferences:
                - type: "select"
                  field: "Industry"
                  value: "AI/ML"
                  options: ["SaaS", "Fintech", "AI/ML", "Developer Tools"]
                  show_in_table: true
    responses:
      '200':
        description: Company updated successfully
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompanyResponse'
      '400':
        $ref: '#/components/responses/BadRequestError'
      '401':
        $ref: '#/components/responses/UnauthorizedError'
      '404':
        $ref: '#/components/responses/NotFoundError'
      '500':
        $ref: '#/components/responses/InternalServerError'

  delete:
    operationId: deleteCompany
    summary: Delete a company
    description: |
      Permanently delete a company and all associated data including
      attachments, notes, and shared access records.
    tags:
      - Companies
    parameters:
      - $ref: '#/components/parameters/CompanyIdParam'
    responses:
      '200':
        description: Company deleted successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                data:
                  type: object
                  properties:
                    message:
                      type: string
                      example: "Company deleted successfully"
      '401':
        $ref: '#/components/responses/UnauthorizedError'
      '404':
        $ref: '#/components/responses/NotFoundError'
      '500':
        $ref: '#/components/responses/InternalServerError'

/companies/{id}/analyze:
  post:
    operationId: analyzeCompany
    summary: Analyze pitch deck with AI
    description: |
      Use AI to analyze the company's pitch deck and extract structured data
      including company information, founder details, and key insights.

      The analysis populates:
      - `metadata.founders` - Team member information
      - `metadata.ai_analysis` - Brief company description
      - `metadata.analyzed_at` - When analysis was performed
      - `metadata.user_preferences` - Extracted custom field values

      **Note**: This operation consumes AI credits.
    tags:
      - Companies
    parameters:
      - $ref: '#/components/parameters/CompanyIdParam'
    requestBody:
      required: false
      content:
        application/json:
          schema:
            type: object
            properties:
              extraData:
                type: object
                description: Additional context to include in the analysis
    responses:
      '200':
        description: Analysis completed successfully
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnalyzeResponse'
      '401':
        $ref: '#/components/responses/UnauthorizedError'
      '404':
        $ref: '#/components/responses/NotFoundError'
      '500':
        $ref: '#/components/responses/InternalServerError'

/companies/{id}/download:
  get:
    operationId: downloadCompanyPdf
    summary: Get pitch deck download URL
    description: |
      Generate a signed download URL for the company's pitch deck PDF.
      URLs are temporary and expire after the specified duration.
    tags:
      - Companies
    parameters:
      - $ref: '#/components/parameters/CompanyIdParam'
      - name: expiry_minutes
        in: query
        required: false
        description: URL expiry time in minutes (default varies by plan)
        schema:
          type: integer
          minimum: 1
          maximum: 1440
    responses:
      '200':
        description: Download URL generated
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                data:
                  type: object
                  properties:
                    download_url:
                      type: string
                      format: uri
                      description: Signed URL for downloading the PDF
                    expires_at:
                      type: string
                      format: date-time
                      description: When the URL expires
      '401':
        $ref: '#/components/responses/UnauthorizedError'
      '404':
        $ref: '#/components/responses/NotFoundError'
      '500':
        $ref: '#/components/responses/InternalServerError'

/companies/{id}/attachments:
  post:
    operationId: uploadCompanyAttachment
    summary: Upload company attachment
    description: |
      Upload additional documents/attachments to a company
      (financials, legal docs, etc.).
    tags:
      - Companies
    parameters:
      - $ref: '#/components/parameters/CompanyIdParam'
    requestBody:
      required: true
      content:
        multipart/form-data:
          schema:
            type: object
            required:
              - file
              - title
              - account_id
            properties:
              file:
                type: string
                format: binary
                description: File to upload
              title:
                type: string
                description: Attachment title
              description:
                type: string
                description: Optional description
              account_id:
                type: string
                format: uuid
    responses:
      '200':
        description: Attachment uploaded
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                data:
                  type: object
                  properties:
                    attachment:
                      $ref: '#/components/schemas/CompanyAttachment'
      '400':
        $ref: '#/components/responses/BadRequestError'
      '401':
        $ref: '#/components/responses/UnauthorizedError'
      '500':
        $ref: '#/components/responses/InternalServerError'
