# Company Schema Definitions

Company:
  type: object
  required:
    - id
    - account_id
    - created_at
    - updated_at
  properties:
    id:
      type: string
      format: uuid
      description: Unique identifier for the company
      example: "0bbd2344-7c60-4541-80ca-b3a5eb862e5c"
    account_id:
      type: string
      format: uuid
      description: Account/team this company belongs to
      example: "90d4ca07-8849-4fa9-b149-5f10d8635449"
    name:
      type: string
      description: Company name
      example: "Freya's Mirror"
      maxLength: 255
    deck_link:
      type: string
      format: uri
      nullable: true
      description: URL to the pitch deck (external link or Tally storage URL)
      example: "https://storage.tally.so/private/Deck.pdf?id=J8DMJJ&accessToken=..."
    deck_storage_path:
      type: string
      nullable: true
      description: Internal storage path for uploaded pitch deck
      example: "companies/7c9e6679/deck.pdf"
    visibility:
      type: string
      enum: [private, shared, team]
      description: |
        Visibility level:
        - `private`: Only visible to the creator
        - `shared`: Visible to specific users via company_shared_access
        - `team`: Visible to all team members
      default: team
      example: "team"
    source:
      type: string
      enum: [manual, email, form, referral, website, event, other]
      nullable: true
      description: How the company was added to the pipeline
      example: "form"
    source_content:
      type: string
      nullable: true
      description: |
        Raw source content when company was created from a form submission.
        Contains the original form field data in a serialized format.
      example: "0: {\"key\":\"question_wbB2ze\",\"type\":\"INPUT_EMAIL\",\"label\":\"Email\",\"value\":\"founder@company.com\"}"
    notes:
      type: string
      nullable: true
      description: Internal notes about the company (not visible to the company)
      example: "Company deck imported from direct PDF link"
    company_status_id:
      type: string
      format: uuid
      nullable: true
      description: Current deal flow status ID
      example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
    company_status:
      nullable: true
      description: Embedded company status object (when joined)
      allOf:
        - $ref: '#/components/schemas/CompanyStatus'
    metadata:
      $ref: '#/components/schemas/CompanyMetadata'
    metadata_search_text:
      type: string
      nullable: true
      description: Flattened metadata for full-text search (auto-generated)
    assignees:
      type: array
      description: List of team members assigned to this company
      items:
        $ref: '#/components/schemas/Assignee'
      default: []
    created_by:
      type: string
      format: uuid
      nullable: true
      description: User ID who created this company record
      example: "5e417c4b-ca57-4545-a995-a805a55e5b71"
    updated_by:
      type: string
      format: uuid
      nullable: true
      description: User ID who last updated this company record
      example: "5e417c4b-ca57-4545-a995-a805a55e5b71"
    created_at:
      type: string
      format: date-time
      description: When the company was created
      example: "2025-11-26T16:09:55.712555+00:00"
    updated_at:
      type: string
      format: date-time
      description: When the company was last updated
      example: "2025-11-26T16:10:35.14483+00:00"

CompanyMetadata:
  type: object
  description: |
    Custom metadata for the company. Contains AI-extracted data, founder info,
    and user-configurable custom fields.
  properties:
    founders:
      type: array
      description: Founder/team member information (typically AI-extracted from pitch deck)
      items:
        $ref: '#/components/schemas/Founder'
    ai_analysis:
      type: string
      nullable: true
      description: AI-generated company description/summary
      example: "Virtual try-on solution for fashion e-commerce to personalize customer experience and drive conversion."
    analyzed_at:
      type: string
      format: date-time
      nullable: true
      description: When the AI analysis was performed
      example: "2025-11-26T16:10:35.114Z"
    user_preferences:
      type: array
      description: Custom fields configured by the account for tracking company data
      items:
        $ref: '#/components/schemas/UserPreference'
  additionalProperties: true

Founder:
  type: object
  description: Information about a company founder or team member
  properties:
    name:
      type: string
      description: Full name
      example: "Fabian Jichi"
    email:
      type: string
      format: email
      nullable: true
      description: Email address
      example: "fabian@freyasmirror.ai"
    phone:
      type: string
      nullable: true
      description: Phone number
      example: "+40727129962"
    title:
      type: string
      nullable: true
      description: Job title/role
      example: "CEO/Founder"
    background:
      type: string
      nullable: true
      description: Professional background summary
      example: "2nd time Startup Founder, ex Lead AI Engineer, 7 years experience in AI"
    linkedin_profile:
      type: string
      format: uri
      nullable: true
      description: LinkedIn profile URL
      example: "https://www.linkedin.com/in/fabian-jichi/"

UserPreference:
  type: object
  description: |
    Custom field for tracking company data. Supports multiple field types:
    - `text`: Free-form text input
    - `boolean`: True/false toggle
    - `select`: Single selection from predefined options
  required:
    - type
    - field
  properties:
    type:
      type: string
      enum: [text, boolean, select]
      description: Field type
      example: "select"
    field:
      type: string
      description: Field name/label
      example: "Industry"
    value:
      oneOf:
        - type: string
        - type: boolean
        - type: "null"
      description: Current value (type depends on field type)
      example: "AI/ML"
    options:
      type: array
      items:
        type: string
      description: Available options (for select fields)
      example: ["SaaS", "Fintech", "AI/ML", "Developer Tools"]
    show_in_table:
      type: boolean
      description: Whether this field is displayed in the companies table view
      default: false
      example: true

Assignee:
  type: object
  description: Team member assigned to a company
  properties:
    id:
      type: string
      format: uuid
      description: User ID of the assignee
    name:
      type: string
      nullable: true
      description: Display name
    email:
      type: string
      format: email
      nullable: true
      description: Email address
    picture_url:
      type: string
      format: uri
      nullable: true
      description: Profile picture URL

CompanyStatus:
  type: object
  description: Deal flow pipeline status
  properties:
    id:
      type: string
      format: uuid
    name:
      type: string
      example: "Initial Review"
    color:
      type: string
      description: Hex color code
      example: "#3B82F6"
    rank:
      type: integer
      description: Order in pipeline (lower = earlier)

CompanyCreate:
  type: object
  required:
    - account_id
  properties:
    account_id:
      type: string
      format: uuid
      description: Account/team this company belongs to
    name:
      type: string
      description: Company name
      maxLength: 255
    deck_link:
      type: string
      format: uri
      description: External pitch deck URL
    notes:
      type: string
      description: Internal notes
    company_status_id:
      type: string
      format: uuid
      nullable: true
      description: Initial deal flow status
    visibility:
      type: string
      enum: [private, shared, team]
      default: team
    source:
      type: string
      enum: [manual, email, form, referral, website, event, other]
      default: manual
    metadata:
      $ref: '#/components/schemas/CompanyMetadata'

CompanyUpdate:
  type: object
  description: All fields are optional for partial updates
  properties:
    name:
      type: string
      maxLength: 255
    deck_link:
      type: string
      format: uri
      nullable: true
    notes:
      type: string
      nullable: true
    company_status_id:
      type: string
      format: uuid
      nullable: true
    visibility:
      type: string
      enum: [private, shared, team]
    source:
      type: string
      enum: [manual, email, form, referral, website, event, other]
    metadata:
      $ref: '#/components/schemas/CompanyMetadata'

CompanyListResponse:
  type: object
  required:
    - success
    - data
  properties:
    success:
      type: boolean
      example: true
    data:
      type: object
      required:
        - companies
        - pagination
      properties:
        companies:
          type: array
          items:
            $ref: '#/components/schemas/Company'
        pagination:
          $ref: '#/components/schemas/CursorPagination'
    authType:
      type: string
      enum: [api_key, session]
      description: Authentication method used for this request

CompanyResponse:
  type: object
  required:
    - success
    - data
  properties:
    success:
      type: boolean
      example: true
    data:
      type: object
      required:
        - company
      properties:
        company:
          $ref: '#/components/schemas/Company'
        pdf_download_url:
          type: string
          format: uri
          description: Signed URL for downloading the pitch deck PDF (if requested)
    authType:
      type: string
      enum: [api_key, session]

CursorPagination:
  type: object
  description: |
    Cursor-based pagination for optimal performance.
    Does not include total counts to avoid expensive database queries.
  required:
    - page
    - limit
    - has_next
    - has_prev
  properties:
    page:
      type: integer
      description: Current page number
      example: 1
    limit:
      type: integer
      description: Number of items per page
      example: 25
    has_next:
      type: boolean
      description: Whether there are more results after this page
      example: true
    has_prev:
      type: boolean
      description: Whether there are results before this page
      example: false

CompanyAttachment:
  type: object
  required:
    - id
    - company_id
    - title
    - storage_path
  properties:
    id:
      type: string
      format: uuid
    company_id:
      type: string
      format: uuid
    title:
      type: string
      example: "Financial Projections"
    description:
      type: string
      nullable: true
      example: "Q4 2024 financial projections spreadsheet"
    storage_path:
      type: string
    file_type:
      type: string
      example: "application/pdf"
    file_size:
      type: integer
      description: File size in bytes
    created_at:
      type: string
      format: date-time
    updated_at:
      type: string
      format: date-time

AnalyzeResponse:
  type: object
  required:
    - success
    - data
  properties:
    success:
      type: boolean
    data:
      type: object
      properties:
        company:
          $ref: '#/components/schemas/Company'
          description: Updated company with AI-extracted metadata
        analysis:
          type: object
          description: Raw analysis results
          properties:
            founders:
              type: array
              items:
                $ref: '#/components/schemas/Founder'
            ai_analysis:
              type: string
              description: AI-generated company summary
            user_preferences:
              type: array
              items:
                $ref: '#/components/schemas/UserPreference'
              description: Extracted custom field values

# AI Upload Schemas

AiUploadRequest:
  type: object
  required:
    - text
    - account_id
  properties:
    text:
      type: string
      minLength: 1
      description: |
        Unstructured text content to process. Can include:
        - Full email body (with headers)
        - Form submission data
        - Meeting notes
        - URLs to pitch decks (DocSend, Google Drive, etc.)

        The AI will extract URLs and analyze context to determine
        company status and source automatically.
      example: |
        From: founder@startup.com
        Subject: TechCo - Series A Deck

        Hi, here's our pitch deck: https://docsend.com/view/abc123

        We're raising $5M at a $20M pre-money valuation.
    account_id:
      type: string
      format: uuid
      description: Account/team ID to create the company under
    name:
      type: string
      description: |
        Optional company name override. If not provided, the AI
        will attempt to extract it from the text or deck.
    visibility:
      type: string
      enum: [private, shared, team]
      default: team
      description: Visibility level for the new company
    notes:
      type: string
      description: Optional internal notes
    company_status_id:
      type: string
      format: uuid
      description: |
        Optional status override. If not provided, the AI will
        attempt to detect an appropriate status from the content.
    source:
      type: string
      enum: [manual, email, form, referral, website, event, other]
      description: |
        Optional source override. If not provided, the AI will
        attempt to detect the source from content context.
    metadata:
      type: object
      additionalProperties: true
      description: Optional custom metadata to merge with AI-extracted data
    file_0:
      type: string
      format: binary
      description: First file attachment (pitch deck or supporting document)
    file_1:
      type: string
      format: binary
      description: Second file attachment
    file_2:
      type: string
      format: binary
      description: Third file attachment
    file_3:
      type: string
      format: binary
      description: Fourth file attachment (up to 10 files supported via file_N pattern)

AiUploadResponse:
  type: object
  required:
    - success
    - data
  properties:
    success:
      type: boolean
      example: true
    data:
      type: object
      required:
        - company
        - attachments
        - analysis
      properties:
        company:
          $ref: '#/components/schemas/Company'
          description: The newly created company
        pdfDownloadUrl:
          type: string
          format: uri
          description: |
            Signed URL for downloading the pitch deck PDF.
            Only present if a deck was successfully processed and stored.
        attachments:
          type: array
          description: List of additional files uploaded as attachments
          items:
            $ref: '#/components/schemas/UploadedAttachment'
        analysis:
          $ref: '#/components/schemas/AiAnalysisResult'
    authType:
      type: string
      enum: [api_key, session]

UploadedAttachment:
  type: object
  description: An attachment uploaded during AI company creation
  properties:
    id:
      type: string
      format: uuid
      description: Attachment UUID
    title:
      type: string
      description: File name/title
      example: "Financial Model.xlsx"
    filePath:
      type: string
      description: Storage path for the file
      example: "companies/7c9e6679/attachments/financial-model.xlsx"
    attachmentType:
      type: string
      description: MIME type of the file
      example: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"

AiAnalysisResult:
  type: object
  description: Details about the AI processing that occurred
  properties:
    detectedUrls:
      type: array
      items:
        type: string
        format: uri
      description: |
        All URLs extracted from the text content using regex.
        Includes signed URLs, short links, and deck platform URLs.
      example:
        - "https://docsend.com/view/abc123"
        - "https://drive.google.com/file/d/xyz"
    selectedDeckUrl:
      type: string
      format: uri
      description: |
        The URL that was selected as the primary pitch deck source.
        Only present if a URL was used (vs. uploaded file).
      example: "https://docsend.com/view/abc123"
    selectedDeckFile:
      type: string
      description: |
        Name of the file that was selected as the primary pitch deck.
        Only present if an uploaded file was used (vs. URL).
      example: "Pitch Deck v2.pdf"
    aiReasoning:
      type: string
      description: |
        Explanation of why the AI selected the particular deck source.
        Useful for debugging and understanding the selection logic.
      example: "Selected DocSend URL as primary deck source (high priority platform)"
    contextAnalysis:
      type: object
      description: Results of AI context analysis on the text content
      properties:
        statusDetected:
          type: boolean
          description: Whether a company status was auto-detected
        statusReasoning:
          type: string
          description: Explanation for the detected status
          example: "Email mentions 'Series A raise' - assigned to fundraising stage"
        sourceDetected:
          type: boolean
          description: Whether a source was auto-detected
        sourceReasoning:
          type: string
          description: Explanation for the detected source
          example: "Content appears to be a forwarded email from founder"
    processedAt:
      type: string
      format: date-time
      description: When the AI processing completed
      example: "2024-01-15T10:30:00Z"
